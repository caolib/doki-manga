name: "android-release"

on:
  repository_dispatch:
    types: [build-release]
  workflow_dispatch:
    inputs:
      version:
        description: "Version number"
        required: true
        default: "v1.4.6"
        type: string

jobs:
  quick-build:
    runs-on: ubuntu-22.04

    steps:
      - name: Debug workflow inputs
        run: |
          echo "Repository dispatch version: ${{ github.event.client_payload.version }}"
          echo "Manual input version: ${{ github.event.inputs.version }}"
          echo "Tag from client_payload: ${{ github.event.client_payload.tag }}"
          echo "Source repo: ${{ github.event.client_payload.source_repo }}"

      - name: Checkout repository (mobile branch)
        uses: actions/checkout@v4
        with:
          repository: caolib/doki
          ref: mobile
          token: ${{ secrets.PAT_TOKEN }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "pnpm"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
          
      - name: Install frontend dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Install Rust stable with Android targets
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,i686-linux-android,x86_64-linux-android

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"
          cache-all-crates: true

      - name: Cache system dependencies
        uses: actions/cache@v4
        id: system-cache
        with:
          path: /var/cache/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install system dependencies
        if: steps.system-cache.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Cache Gradle wrapper and distributions
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
            src-tauri/gen/android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle-wrapper.properties', '**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Cache Android SDK
        uses: actions/cache@v4
        id: android-cache
        with:
          path: |
            ${{ env.ANDROID_HOME }}
            ~/.android
          key: ${{ runner.os }}-android-sdk-34-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-34-
            ${{ runner.os }}-android-sdk-

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        if: steps.android-cache.outputs.cache-hit != 'true'
        run: |
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0" \
            "ndk;26.1.10909125" \
            "cmdline-tools;latest"

      - name: Set Android environment variables
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> $GITHUB_ENV
          
          echo "Androidç¯å¢ƒå˜é‡è®¾ç½®ï¼š"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "JAVA_HOME: $JAVA_HOME"
          echo "NDK_HOME: $ANDROID_HOME/ndk/26.1.10909125"

      - name: Update version in tauri.conf.json
        run: |
          VERSION="${{ github.event.client_payload.version || github.event.inputs.version }}"
          VERSION="${VERSION#v}"
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          echo "Updated version to: $VERSION"

      - name: Cache frontend build
        uses: actions/cache@v4
        id: frontend-cache
        with:
          path: |
            dist
            .next
            node_modules/.cache
          key: ${{ runner.os }}-frontend-${{ hashFiles('**/package.json', '**/pnpm-lock.yaml', 'src/**', 'public/**') }}
          restore-keys: |
            ${{ runner.os }}-frontend-

      - name: Build frontend
        if: steps.frontend-cache.outputs.cache-hit != 'true'
        run: pnpm build

      - name: Cache Tauri Android generation
        uses: actions/cache@v4
        id: tauri-android-cache
        with:
          path: src-tauri/gen/android
          key: ${{ runner.os }}-tauri-android-${{ hashFiles('src-tauri/tauri.conf.json', 'src-tauri/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-tauri-android-

      - name: Initialize Tauri Android project (if needed)
        if: steps.tauri-android-cache.outputs.cache-hit != 'true'
        run: |
          if [ ! -d "src-tauri/gen/android" ]; then
            pnpm tauri android init
          fi

      - name: Setup Gradle wrapper and fix download issues
        run: |
          cd src-tauri/gen/android
          
          # æ£€æŸ¥gradle-wrapper.properties
          if [ -f gradle/wrapper/gradle-wrapper.properties ]; then
            echo "å½“å‰Gradleé…ç½®ï¼š"
            cat gradle/wrapper/gradle-wrapper.properties
            
            # æ›¿æ¢ä¸‹è½½URLä¸ºæ›´ç¨³å®šçš„é•œåƒ
            sed -i 's|https://services.gradle.org/distributions/|https://downloads.gradle.org/distributions/|g' gradle/wrapper/gradle-wrapper.properties
            
            echo "ä¿®æ”¹åçš„Gradleé…ç½®ï¼š"
            cat gradle/wrapper/gradle-wrapper.properties
          fi
          
          # éªŒè¯gradlewæƒé™
          chmod +x gradlew
          
          # å°è¯•é¢„ä¸‹è½½Gradleï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
          echo "é¢„ä¸‹è½½GradleåŒ…..."
          for i in {1..3}; do
            echo "å°è¯• $i/3..."
            if ./gradlew --version; then
              echo "âœ… Gradleä¸‹è½½æˆåŠŸ"
              break
            else
              echo "âš ï¸ ç¬¬$iæ¬¡å°è¯•å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
            fi
            
            if [ $i -eq 3 ]; then
              echo "âŒ Gradleä¸‹è½½å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨ä¸‹è½½..."
              
              # æ‰‹åŠ¨ä¸‹è½½Gradle
              GRADLE_VERSION=$(grep "distributionUrl" gradle/wrapper/gradle-wrapper.properties | cut -d'/' -f6 | cut -d'-' -f2)
              echo "æ£€æµ‹åˆ°Gradleç‰ˆæœ¬: $GRADLE_VERSION"
              
              mkdir -p ~/.gradle/wrapper/dists/gradle-$GRADLE_VERSION-bin
              cd ~/.gradle/wrapper/dists/gradle-$GRADLE_VERSION-bin
              
              # å°è¯•å¤šä¸ªä¸‹è½½æº
              GRADLE_URLS=(
                "https://downloads.gradle.org/distributions/gradle-$GRADLE_VERSION-bin.zip"
                "https://github.com/gradle/gradle/releases/download/v$GRADLE_VERSION.0/gradle-$GRADLE_VERSION-bin.zip"
                "https://services.gradle.org/distributions/gradle-$GRADLE_VERSION-bin.zip"
              )
              
              for url in "${GRADLE_URLS[@]}"; do
                echo "å°è¯•ä» $url ä¸‹è½½..."
                if wget -q --timeout=30 --tries=2 "$url"; then
                  echo "âœ… æ‰‹åŠ¨ä¸‹è½½æˆåŠŸ"
                  break
                fi
              done
            fi
          done

      - name: Setup Android signing (if secrets available)
        run: |
          cd src-tauri
          if [ -n "${{ secrets.DOKI_KEYSTORE_BASE64 }}" ]; then
            base64 -d <<< "${{ secrets.DOKI_KEYSTORE_BASE64 }}" > doki-release-key.keystore
            echo "âœ… å¯†é’¥æ–‡ä»¶å·²æ¢å¤"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç­¾åå¯†é’¥ï¼Œå°†æ„å»ºæœªç­¾åAPK"
          fi

      # ç§»é™¤ç‰¹å®šæ¶æ„é€‰æ‹©ï¼Œæ„å»ºæ‰€æœ‰æ¶æ„
      - name: Install all Android Rust targets
        run: |
          echo "å®‰è£…æ‰€æœ‰Android Rustç›®æ ‡..."
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi  
          rustup target add i686-linux-android
          rustup target add x86_64-linux-android
          echo "âœ… æ‰€æœ‰Android Rustç›®æ ‡å·²å®‰è£…"

      - name: Build Android APK for all platforms
        run: |
          echo "å¼€å§‹æ„å»ºAndroid APK"
          export GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false -Dorg.gradle.jvmargs=-Xmx2g"
          pnpm run build:android

      - name: List generated APK files
        run: |
          echo "æ£€æŸ¥ç”Ÿæˆçš„APKæ–‡ä»¶..."
          
          # æ£€æŸ¥åŸå§‹APKç›®å½•
          ORIGINAL_APK_DIR="src-tauri/gen/android/app/build/outputs/apk/universal/release"
          if [ -d "$ORIGINAL_APK_DIR" ]; then
            echo "åŸå§‹APKç›®å½•å†…å®¹ï¼š"
            ls -la "$ORIGINAL_APK_DIR"
          fi
          
          echo ""
          echo "æŸ¥æ‰¾æ‰€æœ‰APKæ–‡ä»¶ï¼ˆåŒ…æ‹¬é‡å‘½ååçš„ï¼‰ï¼š"
          find . -name "*.apk" -type f -exec ls -lh {} \; | while read line; do
            echo "  $line"
          done
          
          APK_COUNT=$(find . -name "*.apk" -type f | wc -l)
          echo ""
          echo "æ€»å…±æ‰¾åˆ° $APK_COUNT ä¸ªAPKæ–‡ä»¶"

      - name: Create Android Release and Upload APKs
        uses: softprops/action-gh-release@v2
        if: startsWith(github.event.client_payload.version, 'v') || startsWith(github.event.inputs.version, 'v')
        with:
          tag_name: ${{ github.event.client_payload.android_tag || format('{0}-android', github.event.client_payload.version || github.event.inputs.version) }}
          name: "Android Release ${{ github.event.client_payload.version || github.event.inputs.version }}"
          draft: false
          prerelease: false
          body: |
            ğŸ¤– **Androidç‰ˆæœ¬ ${{ github.event.client_payload.version || github.event.inputs.version }}**
            - åº”ç”¨ç‰ˆæœ¬ï¼š${{ github.event.client_payload.version || github.event.inputs.version }}
            - æ„å»ºæ—¶é—´ï¼š${{ github.run_id }}
          files: |
            **/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}