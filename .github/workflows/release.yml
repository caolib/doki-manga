name: "doki-manga-release"

on:
  repository_dispatch:
    types: [build-release]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build (e.g., v1.2.3)"
        required: true
        type: string

jobs:
  release-notes:
    runs-on: ubuntu-22.04
    outputs:
      release_body: ${{ steps.release_notes.outputs.release_body }}
    steps:
      - name: Checkout doki source code
        uses: actions/checkout@v4
        with:
          repository: caolib/doki
          ref: ${{ github.event.client_payload.tag || github.event.inputs.tag }}
          token: ${{ secrets.PAT_TOKEN }}

      - id: release_notes
        continue-on-error: true
        run: |
          if [ -f "./docs/RELEASE.md" ]; then
            {
              echo 'release_body<<EOF'
              cat "./docs/RELEASE.md"
              echo 'EOF'
            } >> "$GITHUB_OUTPUT"
          else
            echo "release_body=See the assets to download this version and install." >> "$GITHUB_OUTPUT"
          fi

  publish-tauri:
    needs: [release-notes]
    if: always() && (needs.release-notes.result == 'success' || needs.release-notes.result == 'skipped')
    permissions:
      contents: write
      actions: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-latest" # for Arm based macs (M1 and above).
            args: "--target aarch64-apple-darwin"
          - platform: "macos-latest" # for Intel based macs.
            args: "--target x86_64-apple-darwin"
          - platform: "ubuntu-22.04"
            args: ""
          - platform: "windows-latest"
            args: ""
    runs-on: ${{ matrix.platform }}
    steps:
      # 验证签名密钥
      - name: Validate Tauri signing key
        shell: bash
        run: |
          echo "🔍 验证签名密钥..."

          # 检查密钥是否存在
          if [ -z "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" ]; then
            echo "❌ 错误: TAURI_SIGNING_PRIVATE_KEY 密钥未设置"
            exit 1
          fi

          if [ -z "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" ]; then
            echo "❌ 错误: TAURI_SIGNING_PRIVATE_KEY_PASSWORD 密码未设置"
            exit 1
          fi

          # 验证密钥格式（base64解码测试）
          echo "🔐 验证密钥格式..."

          # 显示当前密钥的前100个字符用于调试
          echo "🔍 当前密钥前100字符: $(echo "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" | head -c 100)..."

          # 计算原始base64字符串长度
          KEY_LENGTH=$(echo "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" | wc -c)
          echo "📏 base64字符串长度: $KEY_LENGTH"

          # 尝试解码
          if ! echo "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" | base64 -d > /tmp/test-key.key 2>/tmp/decode-error.log; then
            echo "❌ 错误: 私钥不是有效的base64格式"
            echo "解码错误信息:"
            cat /tmp/decode-error.log
            exit 1
          fi

          # 检查解码后的密钥文件大小
          KEY_SIZE=$(stat -c%s /tmp/test-key.key 2>/dev/null || stat -f%z /tmp/test-key.key 2>/dev/null || echo "0")
          echo "📦 解码后文件大小: $KEY_SIZE bytes"

          if [ "$KEY_SIZE" -lt 100 ]; then
            echo "❌ 错误: 解码后的私钥文件太小 ($KEY_SIZE bytes)，可能解码失败"
            exit 1
          fi

          # 显示解码后文件的前几行用于调试
          echo "🔍 解码后文件内容前3行:"
          cat /tmp/test-key.key | head -3

          # 验证密钥格式（支持PEM和rsign格式）
          if grep -q "BEGIN.*PRIVATE KEY" /tmp/test-key.key; then
            echo "✅ 检测到PEM格式私钥"
          elif grep -q "untrusted comment.*rsign" /tmp/test-key.key; then
            echo "✅ 检测到rsign格式私钥"
          else
            echo "❌ 错误: 解码后的文件不包含有效的私钥标识"
            echo "完整文件内容:"
            cat /tmp/test-key.key
            exit 1
          fi

          # 清理临时文件
          rm -f /tmp/test-key.key

          echo "✅ 签名密钥验证通过！"

      - name: Checkout doki source code
        uses: actions/checkout@v4
        with:
          repository: caolib/doki
          ref: ${{ github.event.client_payload.tag || github.event.inputs.tag }}
          token: ${{ secrets.PAT_TOKEN }}

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        continue-on-error: true
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "pnpm"
          cache-dependency-path: "pnpm-lock.yaml"

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        continue-on-error: true
        with:
          workspaces: "./src-tauri -> target"
          cache-on-failure: true
          shared-key: ${{ matrix.platform }}
          save-if: ${{ github.ref == 'refs/heads/main' }}

      - name: install frontend dependencies
        run: pnpm install

      # 设置是否为预发布
      - name: Set prerelease if tag contains beta
        id: set_prerelease
        shell: bash
        run: |
          TAG_NAME=${{ github.event.client_payload.tag || github.event.inputs.tag }}
          if [[ "$TAG_NAME" == *beta* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      # 设置签名密钥文件
      - name: Setup Tauri signing key
        shell: bash
        run: |
          # 清理密钥字符串（移除所有空格、换行符等空白字符）
          CLEAN_KEY=$(echo "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" | tr -d '[:space:]')
          echo "🔧 清理后的密钥长度: ${#CLEAN_KEY}"
          
          # 创建私钥文件
          echo "$CLEAN_KEY" | base64 -d > signing-key.key
          
          # 验证解码成功
          if [ ! -f "signing-key.key" ] || [ ! -s "signing-key.key" ]; then
            echo "❌ 错误: 私钥文件创建失败"
            exit 1
          fi
          
          # 验证文件内容
          if ! grep -q "untrusted comment.*rsign" signing-key.key; then
            echo "❌ 错误: 私钥文件格式不正确"
            cat signing-key.key | head -3
            exit 1
          fi
          
          echo "✅ 私钥文件创建成功"
          
          # 设置环境变量为文件路径（这是关键！）
          echo "TAURI_SIGNING_PRIVATE_KEY=$(pwd)/signing-key.key" >> $GITHUB_ENV
          echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD=${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" >> $GITHUB_ENV

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ env.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ env.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.event.client_payload.tag || github.event.inputs.tag }}
          releaseName: "Release ${{ github.event.client_payload.tag || github.event.inputs.tag }}"
          releaseBody: ${{ needs.release-notes.outputs.release_body || 'See the assets to download this version and install.' }}
          releaseDraft: false
          prerelease: ${{ steps.set_prerelease.outputs.prerelease }}
          args: ${{ matrix.args }}
          includeUpdaterJson: true
