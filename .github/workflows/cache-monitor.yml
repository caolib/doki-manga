name: "Cache Monitor"

on:
  repository_dispatch:
  workflow_dispatch:

jobs:
  monitor-cache:
    runs-on: ubuntu-22.04
    steps:
      - name: Install bc for calculations
        run: sudo apt-get update && sudo apt-get install -y bc

      - name: Monitor cache usage
        run: |
          # è·å–ç¼“å­˜ä½¿ç”¨æƒ…å†µ
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/cache/usage")

          echo "Cache usage response: $response"

          # è§£æç¼“å­˜å¤§å° (å•ä½: bytes)
          cache_size_bytes=$(echo "$response" | jq -r '.active_caches_size_in_bytes // 0')

          # è½¬æ¢ä¸º GB
          cache_size_gb=$(echo "scale=2; $cache_size_bytes / 1024 / 1024 / 1024" | bc)

          echo "Current cache size: ${cache_size_gb} GB"

          # æ£€æŸ¥æ˜¯å¦è¶…è¿‡ 7GB
          threshold_exceeded=$(echo "$cache_size_gb > 7" | bc)

          echo "Threshold exceeded: $threshold_exceeded"

          if [ "$threshold_exceeded" -eq 1 ]; then
            echo "Cache size exceeds 7GB threshold"
            
            # æ£€æŸ¥ issue #6 æ˜¯å¦å·²æ‰“å¼€
            issue_state=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/6" | jq -r '.state')
            
            echo "Current issue #6 state: $issue_state"
            
            if [ "$issue_state" = "closed" ]; then
              # é‡æ–°æ‰“å¼€ issue
              echo "Reopening issue #6"
              curl -X PATCH -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/6" \
                -d '{"state": "open"}'
            fi
            
            # æ·»åŠ è¯„è®ºåˆ° issue #6
            echo "Adding comment to issue #6"
            current_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/6/comments" \
              -d "{\"body\": \"âš ï¸ **Cache Usage Alert** - $current_time\\n\\nğŸ“Š Current cache usage: **${cache_size_gb} GB**\\nğŸš¨ This exceeds the 7GB threshold.\\n\\n**Recommended actions:**\\n- Review and clean up unused cache entries\\n- Consider optimizing build workflows to reduce cache usage\\n- Monitor cache usage more frequently\\n\\n---\\n*This alert was automatically generated by the cache monitoring workflow.*\"}"
            
          else
            echo "Cache size is within acceptable limits"
            
            # æ£€æŸ¥ issue #6 æ˜¯å¦æ‰“å¼€ï¼Œå¦‚æœæ˜¯åˆ™å…³é—­å®ƒ
            issue_state=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/6" | jq -r '.state')
            
            echo "Current issue #6 state: $issue_state"
            
            if [ "$issue_state" = "open" ]; then
              echo "Closing issue #6 as cache usage is now acceptable"
              
              # æ·»åŠ å…³é—­è¯„è®º
              current_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
              curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/6/comments" \
                -d "{\"body\": \"âœ… **Cache Usage Normal** - $current_time\\n\\nğŸ“Š Current cache usage: **${cache_size_gb} GB**\\nâœ… Cache usage is now within acceptable limits (< 7GB).\\n\\nClosing this issue automatically.\\n\\n---\\n*This update was automatically generated by the cache monitoring workflow.*\"}"
              
              # å…³é—­ issue
              curl -X PATCH -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/6" \
                -d '{"state": "closed"}'
            fi
          fi
